<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SITCON 人物關係圖 - 開發測試版</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #f5f5f5;
            font-family: Arial, sans-serif;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .controls {
            background: white;
            padding: 15px;
            border-bottom: 1px solid #ddd;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .control-group label {
            font-weight: bold;
            min-width: 80px;
        }

        .control-group select, .control-group input {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        .control-group button {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 3px;
            cursor: pointer;
        }

        .control-group button:hover {
            background: #2980b9;
        }

        #echarts {
            width: 100%;
            height: calc(100vh - 140px);
            background: #ffffff;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>SITCON 人物關係圖 - 開發測試版</h1>
        <p>Apache ECharts 視覺化引擎</p>
    </div>

    <div class="controls">
        <div class="control-group">
            <label>佈局方式:</label>
            <select id="layoutType">
                <option value="force" selected>力導向</option>
                <option value="circular">圓形佈局</option>
            </select>
        </div>

        <div class="control-group">
            <label>線條樣式:</label>
            <select id="edgeStyle">
                <option value="straight" selected>直線</option>
                <option value="curve">曲線</option>
            </select>
        </div>

        <div class="control-group">
            <label>線條粗細:</label>
            <input type="range" id="lineWidth" min="1" max="10" value="1" />
            <span id="lineWidthValue">1</span>
        </div>

        <div class="control-group">
            <label>節點大小:</label>
            <input type="range" id="nodeSize" min="30" max="100" value="40" />
            <span id="nodeSizeValue">40</span>
        </div>

        <div class="control-group">
            <label>節點間距:</label>
            <input type="range" id="edgeLength" min="80" max="250" value="100" />
            <span id="edgeLengthValue">100</span>
        </div>

        <div class="control-group">
            <label>線條透明度:</label>
            <input type="range" id="opacity" min="0.1" max="1" step="0.1" value="0.8" />
            <span id="opacityValue">0.8</span>
        </div>

        <div class="control-group">
            <button onclick="updateGraph()">套用變更</button>
        </div>

        <div class="control-group">
            <button onclick="resetLayout()">重新佈局</button>
        </div>
    </div>

    <div id="echarts"></div>

    <script>
        let echartsInstance;
        let graphData;

        // 頁面載入時初始化
        window.addEventListener('load', async function() {
            await loadGraphData();
            initializeECharts();
            setupEventListeners();
        });

        // 載入圖表資料
        async function loadGraphData() {
            try {
                const response = await fetch('/api/graph');
                graphData = await response.json();
                console.log('載入資料:', graphData);
            } catch (error) {
                console.error('載入資料失敗:', error);
                alert('載入資料失敗，請檢查伺服器連線');
            }
        }

        // 初始化 ECharts
        function initializeECharts() {
            if (!graphData) return;

            const container = document.getElementById('echarts');
            echartsInstance = echarts.init(container, null, {
                renderer: 'canvas',  // 使用 canvas 渲染器,效能較好
                devicePixelRatio: window.devicePixelRatio || 1
            });

            updateGraph();
        }

        // 更新 ECharts 圖表
        function updateGraph() {
            if (!echartsInstance || !graphData) return;

            const nodeSize = parseInt(document.getElementById('nodeSize').value) || 40;
            const lineWidth = parseInt(document.getElementById('lineWidth').value) || 8;
            const opacity = parseFloat(document.getElementById('opacity').value) || 0.8;
            const edgeLength = parseInt(document.getElementById('edgeLength').value) || 100;
            const edgeStyle = document.getElementById('edgeStyle').value;
            const layoutType = document.getElementById('layoutType').value;

            // 轉換資料格式為 ECharts 格式
            const nodes = graphData.nodes.map(node => ({
                id: node.id,
                name: node.label,
                symbolSize: nodeSize,
                itemStyle: {
                    color: '#77B55A',
                    borderColor: '#77B55A',
                    borderWidth: 2
                },
                label: {
                    show: true,
                    color: '#fff',
                    fontSize: Math.max(10, nodeSize * 0.2),
                    fontWeight: 'bold',
                    textBorderColor: '#2d4a1f',
                    textBorderWidth: 2
                }
            }));

            const links = graphData.edges.map(edge => ({
                source: edge.from,
                target: edge.to,
                lineStyle: {
                    width: lineWidth,
                    color: `rgba(128, 128, 128, ${opacity})`,  // 灰色
                    curveness: edgeStyle === 'curve' ? 0.2 : 0
                }
            }));

            // 根據佈局類型設定不同的配置
            let seriesConfig = {
                type: 'graph',
                data: nodes,
                links: links,
                roam: true,
                draggable: true,
                left: 0,
                right: 0,
                top: 0,
                bottom: 0,
                emphasis: {
                    focus: 'adjacency',
                    lineStyle: {
                        width: lineWidth + 2
                    }
                }
            };

            if (layoutType === 'circular') {
                // 圓形佈局
                seriesConfig.layout = 'circular';
                seriesConfig.circular = {
                    rotateLabel: false
                };
            } else {
                // 力導向佈局 - 優化參數減少重疊
                seriesConfig.layout = 'force';
                seriesConfig.force = {
                    repulsion: 1800,
                    gravity: 0.2,
                    edgeLength: 150,
                    layoutAnimation: false,
                    friction: 0.6,
                    initLayout: 'circular'
                };
                // 設定力導向迭代次數
                seriesConfig.layoutIterations = 500;  // 增加迭代次數以獲得更好的佈局
            }

            const option = {
                backgroundColor: '#ffffff',
                animation: false,
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        if (params.dataType === 'node') {
                            return `人物: ${params.name}<br/>ID: ${params.data.id}`;
                        } else if (params.dataType === 'edge') {
                            return `關係: ${params.data.source} ↔ ${params.data.target}`;
                        }
                    },
                    renderMode: 'html',  // 使用 HTML 渲染 tooltip,效能較好
                    appendToBody: true
                },
                series: [seriesConfig]
            };

            // 使用 notMerge: true 和 lazyUpdate: true 提升效能
            echartsInstance.setOption(option, {
                notMerge: true,
                lazyUpdate: false
            });
        }

        // 重新佈局
        function resetLayout() {
            if (!echartsInstance) return;

            // 顯示載入中
            echartsInstance.showLoading({
                text: '重新計算佈局中...',
                color: '#77B55A'
            });

            // 延遲執行避免卡頓
            setTimeout(() => {
                echartsInstance.clear();
                updateGraph();
                echartsInstance.hideLoading();
            }, 100);
        }

        // 設定事件監聽器
        function setupEventListeners() {
            document.getElementById('lineWidth').addEventListener('input', function() {
                document.getElementById('lineWidthValue').textContent = this.value;
            });

            document.getElementById('nodeSize').addEventListener('input', function() {
                document.getElementById('nodeSizeValue').textContent = this.value;
            });

            document.getElementById('edgeLength').addEventListener('input', function() {
                document.getElementById('edgeLengthValue').textContent = this.value;
            });

            document.getElementById('opacity').addEventListener('input', function() {
                document.getElementById('opacityValue').textContent = this.value;
            });
        }

        // 視窗大小改變時調整圖表
        window.addEventListener('resize', function() {
            if (echartsInstance) {
                echartsInstance.resize();
            }
        });
    </script>
</body>
</html>
